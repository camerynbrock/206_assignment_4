---
title: "ESM 206 Assignment 4"
author: "Cameryn Brock and Allie Hacker"
date: "11/14/2019"
output: html_document
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, message=FALSE, warning=FALSE}

# Attach packages

library(tidyverse)
library(janitor)

# Read in & clean up data

lobster_data <- read_csv("lobster_abundance_sbc_lter.csv", 
                         na = "-99999") %>% 
  clean_names()

# Tidy data by uncounting counts

lobster_tidy <- lobster_data %>% 
  uncount(count)

# Add MPA column to data
lobster_mpa <- lobster_tidy %>% 
  mutate(mpa= ifelse(site %in% c("IVEE", "NAPL"), "MPA", "non-MPA" ))

```
#### Introduction

To be written
-purpose: investigate how MPA status effects lobster abundance and size
-

#### Data and Methods

California Spiny Lobster data were provided by the [Environmental Data Initiative](https://environmentaldatainitiative.org/). Lobster abundace (individuals) and size (mm) were determined by annual SCUBA surveys at five long term kelp forest research sites in the Santa Barbara Channel. Two of the sites, Isla Vista and Naples, were established as Marine Protected Areas (MPAs) in 2012. Data collection began in late summer of 2012 before the start of fishing season and is ongoing.

Changes in lobster abundance and shifts in lobster size distribution from 2012 to 2018 were explored for each study site. Mean lobster size (mm) at MPA sites and non-MPA sites was compared for both 2012 and 2018 using two-sample t-tests (\alpha = 0.05). Mean lobster size in 2012 and 2018 was compared for MPA and non-MPA sites using two-sample t-tests. R software (version 3.5.1) and RStudio (version 1.2.1335) were used for data analysis and figure generation. 

#### Results

##### 1. Changes in annual lobster abundance.

California Spiny Lobster abundance increased from 2012 to 2018 at all five sampling locations. The two Marine Protected Area sites Isla Vista and Naples) had the lowest lobster abundance in 2012 and the greatest percent increase in lobster abundance from 2012 to 2018. The number of lobsters observed at Isla Vista increased 36-fold from 26 in 2012 to 946 in 2018. At Naples, lobster abundance increased 49-fold from 6 lobsters in 2012 to 298 in 2018. 

```{r Part A: Changes in lobster abundance}
# Part A: Changes in annual lobster abundance by site

# get annual count of lobsters for each site
lobster_abundance <- lobster_tidy %>% 
  count(site, year) %>% 
  mutate(mpa= ifelse(site %in% c("IVEE", "NAPL"), "MPA", "non-MPA" ))

# compare abundance in 2012 to abundance in 2018
lobster_abundance_compare <- lobster_abundance %>% 
  filter (year == 2012 | year == 2018)

# graph lobster abundance

ggplot(lobster_abundance, 
       aes(x = year, 
           y = n, 
           group = site, 
           color = mpa, 
           size = mpa)
       )+
  geom_line()+
  scale_color_manual(values = c("aquamarine3", "indianred3"))+
  scale_size_manual(values = c(1.2, 0.5))+
  theme_classic()+
  theme_minimal()+
  labs(x= "Year", y = "Lobsters abundance")+
  scale_x_continuous(breaks = seq(2012, 2018, 1), expand = c(0,0))+
  scale_y_continuous(breaks = seq(0, 1010, 200), expand = c(0,100))+
  coord_cartesian(clip = 'off')+
  theme(legend.title = element_blank(),
        legend.background = element_rect(color = "black"),
        legend.position = c(0.2, 0.8),
        plot.margin = unit(c(0.5,2.5,0,0),"cm"),
        axis.line = element_line(color = "black"))+
  annotate("text", 
           x = 2018.05, 
           y = 946, 
           label = "Isla Vista", 
           size = 3, 
           hjust = 0)+
  annotate("text", 
           x = 2018.05, 
           y = 290, 
           label = "Naples", 
           size = 3, 
           hjust = 0)+
  annotate("text", 
           x = 2018.05, 
           y = 164, 
           label = "Mohawk", 
           size = 3, 
           hjust = 0)+
  annotate("text", 
           x = 2018.05, 
           y = 355, 
           label = "Carpenteria", 
           size = 3, 
           hjust = 0)+
  annotate("text", 
           x = 2018.05, 
           y = 54, 
           label = "Arroyo Quemado", 
           size = 3, 
           hjust = 0)

```

***Figure 1.** California Spiny Lobster abundance in the Santa Barbara Channel from 2012 to 2018. Sites shown in turquoise were established as Marine Protected Areas (MPAs) in 2012.*

##### 2. Shifts in lobster size distributions.

There was a notable increase in lobster size between 2012 and 2018 in sites that were established as MPAs (Isla Vista, Naples). No substantial shifts in lobster size were observed in sites that were not established as MPAs (Arroyo Quemado, Carpinteria, Mohawk).  

```{r Part B: Shifts in lobster size distributions, message = FALSE, warning = FALSE, fig.asp = 7/20}
# Compare lobster size distributions by site for 2012 and 2018

lobster_size_dist <- lobster_tidy %>% 
  select(year, site, size_mm) %>% 
  filter(year %in% c("2012", "2018")) %>% 
  mutate(mpa = ifelse(site %in% c("IVEE", "NAPL"), "MPA", "Non-MPA" ))

library(ggridges)

site_labs <- c("Arroyo Quemado", "Carpinteria", "Isla Vista", "Mohawk", "Naples")
names(site_labs) <- c("AQUE", "CARP", "IVEE", "MOHK", "NAPL")

ggplot(data = lobster_size_dist, aes(x = size_mm,
                                     y = factor(year, level = c('2018', '2012')))) + 
  stat_density_ridges(aes(fill = mpa,
                          alpha = year),
                      color = "white",
                      size = 0.4,
                      quantile_lines = TRUE,
                      quantiles = 2) +
  facet_wrap(~site,
             nrow = 1,
             labeller = labeller(site = site_labs)) +
  scale_x_continuous(breaks = c(50, 75, 100),
                     limits = c(25, 125),
                     expand = c(0, 0)) +
  scale_y_discrete(expand = c(0.04, 0.04)) +
  scale_fill_manual(values = c("aquamarine3", "indianred3")) +
  scale_alpha(guide = "none",
              range = c(0.55, 0.95)) +
  theme_minimal() +
  theme(panel.spacing.x = unit(0.5, "lines"),
        legend.key.size = unit(0.65,"line")) +
  labs(x = "Lobster size (mm)",
       y = element_blank()) +
  theme(legend.title = element_blank(),
        legend.position = c(0.805, 0.85),
        legend.text = element_text(size = 8),
        panel.grid.minor.x = element_blank(),
        legend.margin = unit(1, "lines"),
        legend.box.just = "top",
        legend.background = element_rect(color = "white"))

```

***Figure 2.** California Spiny Lobster size distributions in the Santa Barbara Channel in 2012 and 2018. Sites shown in turquoise were established as Marine Protected Areas (MPAs) in 2012. White lines indicate the median lobster size for each facet.*


```{r, include = FALSE}
# Mean Lobster size at MPA vs. non-MPA

library(effsize)

lobster_size_mpa <- lobster_mpa %>% 
  group_by(mpa, year) %>% 
  summarise(mean_size_mm = mean(size_mm, na.rm = TRUE),
            sd_size = sd(size_mm, na.rm = TRUE),
            lobster_number = n())

# t-test for 2012 lobster size MPA vs non-MPA (two-sample, two-sided, unpaired t-test)

mpa_2012_sample <- lobster_mpa %>% 
  filter(mpa == "MPA", year == "2012") %>% 
  pull(size_mm)

non_mpa_2012_sample <- lobster_mpa %>% 
  filter(mpa == "non-MPA", year == "2012") %>% 
  pull(size_mm)

mpa_2012_ttest <- t.test(mpa_2012_sample, non_mpa_2012_sample)

mpa_2012_ttest

# Calculate effect size

mpa_2012_effect <- cohen.d(mpa_2012_sample, non_mpa_2012_sample, na.rm = TRUE)
mpa_2012_effect

# t-test for 2018 lobster size MPA vs non-MPA (two-sample, two-sided, unpaired t-test)

mpa_2018_sample <- lobster_mpa %>% 
  filter(mpa == "MPA", year == "2018") %>% 
  pull(size_mm)

non_mpa_2018_sample <- lobster_mpa %>% 
  filter(mpa == "non-MPA", year == "2018") %>% 
  pull(size_mm)

mpa_2018_ttest <- t.test(mpa_2018_sample, non_mpa_2018_sample)

mpa_2018_ttest

# Calculate effect size

mpa_2018_effect <- cohen.d(non_mpa_2018_sample, mpa_2018_sample, na.rm = TRUE)
mpa_2018_effect


```


```{r, include = FALSE}

# Cam's recommendation to change this part to 

# Change in size at MPA sites from 2012 to 2018 (two-sample, two-sided, unpaired t-test)

mpa_size_ttest <- t.test(mpa_2012_sample, mpa_2018_sample)

mpa_size_ttest

# Calculate effect size

mpa_size_effect <- cohen.d(mpa_2018_sample, mpa_2012_sample, na.rm = TRUE)
mpa_size_effect


# Change in size at non-MPA sizes from 2012 to 2018 (two-sample, two-sided, paired t-test)

non_mpa_size_ttest <- t.test(non_mpa_2012_sample, non_mpa_2018_sample)

non_mpa_size_ttest

# Calculating effect size

non_mpa_size_effect <- cohen.d(non_mpa_2018_sample, non_mpa_2012_sample, na.rm = TRUE)
non_mpa_size_effect

```

In 2012, mean lobster size in non-MPA sites was larger than in MPA sites by about 7.5 mm, with a medium effect size (t test (`r round(mpa_2012_ttest$parameter, 0)`), t = `r round(mpa_2012_ttest$statistic, 2)`, p-value = `r round(mpa_2012_ttest$p.value, 4)`, Cohen's d = `r round(mpa_2012_effect$estimate, 2)`). In 2018, mean lobster size was larger in MPAs than in non-MPAs by about 4 mm with a small effect size (t test (`r round(mpa_2018_ttest$parameter, 0)`), t = `r round(mpa_2018_ttest$statistic, 2)`, p-value = `r round(mpa_2018_ttest$p.value, 14)`, Cohen's d = `r round(mpa_2018_effect$estimate, 2)`).

Between 2012 and 2018, mean lobster size in MPA sites increased by about 10 mm with a large effect size (t test (`r round(mpa_size_ttest$parameter, 0)`),t = `r round(mpa_size_ttest$statistic, 2)`, p-value = `r round(mpa_size_ttest$p.value, 6)`, Cohen's d = `r round(mpa_size_effect$estimate, 2)`) and decreased by about 1.3 mm in non-MPA sites with a small effect size (t test (`r round(non_mpa_size_ttest$parameter, 0)`), t = `r round(non_mpa_size_ttest$statistic, 2)`, p-value = `r round(non_mpa_size_ttest$p.value, 2)`, Cohen's d = `r round(non_mpa_size_effect$estimate, 2)`))

##### 3. Mean lobster sizes at MPA and non-MPA sites in 2012 and 2018.

***Table 1.** California Spiny Lobster mean size, standard deviation, and sample size in 2012 and 2018.*

```{r, message = FALSE, warning = FALSE}

library(knitr)
library(kableExtra)

lobster_summary <- lobster_size_dist %>% 
  group_by(mpa, year) %>% 
  summarize(mean_size = mean(size_mm, na.rm = TRUE),
            sd_size = sd(size_mm, na.rm = TRUE ),
            sample_n = n()) %>% 
  rename("Status" = mpa,
         "Sample Size" = sample_n,
         "Mean Size (mm)" = mean_size,
         "Standard Deviation" = sd_size,
         "Year" = year) 

kable(lobster_summary, digits = 2) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) 

```


#### Summary

- Lobster abunadance increased at all site from 2012 to 2018, with the biggest increases at MPA sites (Figure 1).
- Lobster size increased at MPA sites from 2012 to 2018, but did not increase at non-MPA sites (Figure 2).
- Mean lobster size was larger at non-MPA sites than at MPA sites in 2012, but in 2018, mean lobster size was greater at MPA sites than non-MPA sites (Table 1).

#### References 

**Reed D. 2019.** SBC LTER: Reef: Abundance, size and fishing effort for California Spiny Lobster (Panulirus interruptus), ongoing since 2012. Environmental Data Initiative. https://doi.org/10.6073/pasta/a593a675d644fdefb736750b291579a0. Dataset accessed 10/30/2019.

